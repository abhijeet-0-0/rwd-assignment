<!DOCTYPE html>
<html>
<head>
<title>Confirm Booking</title>
<style>
body{
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height:100vh;
  padding:20px;
  margin:0;
}
.container{
  max-width:600px;
  margin:auto;
  background:#fff;
  padding:40px;
  border-radius:15px;
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
}
h2{
  text-align:center;
  color:#333;
  margin-bottom:30px;
}
.booking-details{
  background:#f8f9fa;
  padding:25px;
  border-radius:10px;
  margin-bottom:30px;
}
.detail-row{
  display:flex;
  justify-content:space-between;
  padding:12px 0;
  border-bottom:1px solid #dee2e6;
}
.detail-row:last-child{
  border-bottom:none;
}
.detail-label{
  font-weight:bold;
  color:#555;
}
.detail-value{
  color:#333;
}
.total{
  background:#667eea;
  color:#fff;
  padding:15px;
  border-radius:8px;
  font-size:20px;
  font-weight:bold;
  text-align:center;
  margin-bottom:20px;
}
button{
  width:100%;
  padding:15px;
  background:linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color:#fff;
  border:none;
  border-radius:8px;
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
}
button:hover{
  transform:translateY(-2px);
  box-shadow:0 5px 15px rgba(40,167,69,0.4);
}
button:disabled{
  background:#ccc;
  cursor:not-allowed;
}
#msg{
  text-align:center;
  margin-top:15px;
  padding:10px;
  border-radius:5px;
}
.success{
  background:#d4edda;
  color:#155724;
}
.error{
  background:#f8d7da;
  color:#721c24;
}
</style>
</head>
<body>

<script>
if(!localStorage.userEmail || !localStorage.flight) location.href="index.html";
</script>

<div class="container">
  <h2>Confirm Your Booking</h2>
  
  <div class="booking-details">
    <div class="detail-row">
      <span class="detail-label">Flight:</span>
      <span class="detail-value" id="flightName"></span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Route:</span>
      <span class="detail-value" id="route"></span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Passenger Name:</span>
      <span class="detail-value" id="passengerName"></span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Age:</span>
      <span class="detail-value" id="passengerAge"></span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Seat Number:</span>
      <span class="detail-value" id="seatNumber"></span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Travel Date:</span>
      <span class="detail-value" id="bookingDate"></span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Passengers:</span>
      <span class="detail-value">1</span>
    </div>
  </div>
  
  <div class="total">
    Total Amount: ₹<span id="totalPrice"></span>
  </div>
  
  <button id="confirmBtn" onclick="confirmBooking()">Confirm Booking</button>
  <div id="msg"></div>
</div>

<script>
// Display booking details
document.getElementById('flightName').textContent = localStorage.flight || 'N/A';
document.getElementById('route').textContent = `${localStorage.source || ''} → ${localStorage.destination || ''}`;
document.getElementById('passengerName').textContent = localStorage.passengerName || 'N/A';
document.getElementById('passengerAge').textContent = localStorage.passengerAge || 'N/A';
document.getElementById('seatNumber').textContent = localStorage.seatNumber || 'N/A';

// Format travel date for display
const travelDate = localStorage.travelDate || new Date().toISOString().slice(0,10);
if(travelDate) {
  const date = new Date(travelDate + 'T00:00:00');
  document.getElementById('bookingDate').textContent = date.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
} else {
  document.getElementById('bookingDate').textContent = new Date().toLocaleDateString();
}

document.getElementById('totalPrice').textContent = localStorage.price || '0';

function confirmBooking(){
  const btn = document.getElementById('confirmBtn');
  const msg = document.getElementById('msg');
  
  // Validate required data
  if(!localStorage.userEmail || !localStorage.flight || !localStorage.source || !localStorage.destination || !localStorage.price){
    msg.className = 'error';
    msg.textContent = 'Missing booking information. Please start over.';
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Processing...';
  
  // Prepare booking data with proper types
  const travelDate = localStorage.travelDate || new Date().toISOString().slice(0,10);
  const bookingData = {
    email: localStorage.userEmail,
    flight_name: localStorage.flight,
    source: localStorage.source,
    destination: localStorage.destination,
    date: travelDate, // Use selected travel date
    passengers: 1,
    price: parseInt(localStorage.price) || 0,
    passenger_name: localStorage.passengerName || '',
    passenger_age: localStorage.passengerAge ? parseInt(localStorage.passengerAge) : null,
    seat_number: localStorage.seatNumber || ''
  };
  
  fetch("/book", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(bookingData)
  })
  .then(r => r.json())
  .then(data => {
    if(data.success){
      msg.className = 'success';
      msg.textContent = 'Booking confirmed successfully!';
      setTimeout(() => {
        // Clear booking-related localStorage
        localStorage.removeItem('flight');
        localStorage.removeItem('price');
        localStorage.removeItem('source');
        localStorage.removeItem('destination');
        localStorage.removeItem('seatNumber');
        localStorage.removeItem('passengerName');
        localStorage.removeItem('passengerAge');
        localStorage.removeItem('travelDate');
        location.href = 'mybookings.html';
      }, 1500);
    } else {
      msg.className = 'error';
      msg.textContent = data.message || 'Booking failed. Please try again.';
      btn.disabled = false;
      btn.textContent = 'Confirm Booking';
    }
  })
  .catch(err => {
    msg.className = 'error';
    msg.textContent = 'An error occurred. Please try again.';
    btn.disabled = false;
    btn.textContent = 'Confirm Booking';
  });
}
</script>

</body>
</html>
